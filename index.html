<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JMR Aurum & Argentum</title>
    
    <!-- 1. Estilos: Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Motor: React y Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Configuración para móvil -->
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body class="bg-slate-50 select-none">
    <div id="root"></div>

    <script type="text/babel">

        const APP_PIN_HASH = "9c55b07c46330c6621ef6b2fea5f2ceb51acb3b7d68258580716e0937d88a47d"; 
        // ---------------------------------------------

        // --- Iconos SVG ---
        const Icon = ({ path, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Wallet: (props) => <Icon {...props} path={<><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4" /><path d="M3 5v14a2 2 0 0 0 2 2h16v-5" /><path d="M18 12a2 2 0 0 0 0 4h4v-4Z" /></>} />,
            Banknote: (props) => <Icon {...props} path={<><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></>} />,
            TrendingUp: (props) => <Icon {...props} path={<><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></>} />,
            TrendingDown: (props) => <Icon {...props} path={<><polyline points="23 18 13.5 8.5 8.5 13.5 1 6" /><polyline points="17 18 23 18 23 12" /></>} />,
            Coins: (props) => <Icon {...props} path={<><circle cx="8" cy="8" r="6" /><path d="M18.09 10.37A6 6 0 1 1 10.34 18" /><path d="M7 6h1v4" /><path d="m16.71 13.88.7.71-2.82 2.82" /></>} />,
            PieChart: (props) => <Icon {...props} path={<><path d="M21.21 15.89A10 10 0 1 1 8 2.83" /><path d="M22 12A10 10 0 0 0 12 2v10z" /></>} />,
            Plus: (props) => <Icon {...props} path={<><path d="M5 12h14" /><path d="M12 5v14" /></>} />,
            Trash2: (props) => <Icon {...props} path={<><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></>} />,
            Edit: (props) => <Icon {...props} path={<><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></>} />,
            RefreshCw: (props) => <Icon {...props} path={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" /></>} />,
            AlertCircle: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></>} />,
            X: (props) => <Icon {...props} path={<><path d="M18 6 6 18" /><path d="m6 6 12 12" /></>} />,
            Lock: (props) => <Icon {...props} path={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>} />,
            LogOut: (props) => <Icon {...props} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" x2="9" y1="12" y2="12" /></>} />,
            Download: (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></>} />,
            Upload: (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></>} />,
            Settings: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></>} />,
            Camera: (props) => <Icon {...props} path={<><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>} />,
            Image: (props) => <Icon {...props} path={<><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><circle cx="8.5" cy="8.5" r="1.5" /><polyline points="21 15 16 10 5 21" /></>} />,
        };

        const { useState, useEffect, useMemo, useRef } = React;

        // --- Componentes UI ---
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>
                {children}
            </div>
        );

        // Tarjeta rediseñada con colores sólidos y vibrantes
        const StatCard = ({ title, value, subtext, trend, icon: IconComponent, colorClass = "text-slate-600", bgClass = "bg-slate-100" }) => (
            <Card className="p-3 sm:p-4 flex flex-col justify-between h-full">
                <div className="flex justify-between items-start mb-2">
                    <p className="text-[10px] sm:text-xs font-bold uppercase tracking-wider text-slate-500 truncate pr-2 mt-1">{title}</p>
                    <div className={`p-2 rounded-lg shrink-0 ${bgClass}`}>
                        <IconComponent size={20} className={colorClass} />
                    </div>
                </div>
                <div>
                    <h3 className={`text-base sm:text-2xl font-bold leading-tight truncate ${colorClass}`}>{value}</h3>
                    {subtext && (
                        <div className="mt-1">
                             <p className={`text-[10px] sm:text-xs font-medium flex items-center ${trend === 'up' ? 'text-emerald-600' : trend === 'down' ? 'text-rose-600' : 'text-slate-500'}`}>
                                {trend === 'up' ? <Icons.TrendingUp size={10} className="mr-0.5 shrink-0" /> : trend === 'down' ? <Icons.TrendingDown size={10} className="mr-0.5 shrink-0" /> : null}
                                <span className="truncate">{subtext}</span>
                            </p>
                        </div>
                    )}
                </div>
            </Card>
        );

        const Button = ({ children, onClick, variant = 'primary', className = '', ...props }) => {
            const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-offset-1 disabled:opacity-50 disabled:cursor-not-allowed select-none active:scale-95";
            const variants = {
                primary: "bg-slate-900 text-white hover:bg-slate-800 focus:ring-slate-900",
                secondary: "bg-white text-slate-700 border border-slate-300 hover:bg-slate-50 focus:ring-slate-200",
                danger: "bg-rose-50 text-rose-600 hover:bg-rose-100 focus:ring-rose-200",
                gold: "bg-amber-400 text-amber-950 hover:bg-amber-500 focus:ring-amber-400"
            };
            return (
                <button 
                    onClick={onClick} 
                    className={`${baseStyle} ${variants[variant]} ${className}`}
                    {...props}
                >
                    {children}
                </button>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm p-4 animate-[fadeIn_0.2s_ease-out]">
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden animate-[zoomIn_0.2s_ease-out] flex flex-col max-h-[90vh]">
                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 shrink-0">
                            <h3 className="text-lg font-bold text-slate-800">{title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><Icons.X size={20}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Componente de Bloqueo Seguro ---
        const LockScreen = ({ onUnlock }) => {
            const [pin, setPin] = useState("");
            const [error, setError] = useState(false);

            const verifyPin = async (inputPin) => {
                const encoder = new TextEncoder();
                const data = encoder.encode(inputPin);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return hashHex === APP_PIN_HASH;
            };

            const handlePinChange = async (e) => {
                const newPin = e.target.value;
                setPin(newPin);
                setError(false);

                // Auto-desbloqueo al llegar a 4 dígitos
                if (newPin.length === 4) {
                    const isValid = await verifyPin(newPin);
                    if (isValid) {
                        onUnlock();
                    } else {
                        setError(true);
                        if (navigator.vibrate) navigator.vibrate(200);
                        // Opcional: borrar PIN tras error
                        // setTimeout(() => setPin(""), 500); 
                    }
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                // Fallback por si el usuario pulsa Enter
                const isValid = await verifyPin(pin);
                if (isValid) {
                    onUnlock();
                } else {
                    setError(true);
                    setPin("");
                    if (navigator.vibrate) navigator.vibrate(200);
                }
            };

            return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-xs rounded-2xl p-8 shadow-2xl text-center">
                        <div className="w-16 h-16 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto mb-6">
                            <Icons.Lock size={32} />
                        </div>
                        <h2 className="text-xl font-bold text-slate-900 mb-2">Acceso Restringido</h2>
                        <p className="text-slate-500 text-sm mb-6">Introduce el PIN de seguridad</p>
                        
                        <form onSubmit={handleSubmit}>
                            <input 
                                type="password" 
                                pattern="[0-9]*" 
                                inputMode="numeric"
                                className={`w-full text-center text-3xl tracking-[0.5em] font-bold py-3 border-b-2 outline-none mb-6 transition-colors ${error ? 'border-rose-500 text-rose-600' : 'border-slate-200 text-slate-800 focus:border-slate-900'}`}
                                placeholder="••••"
                                maxLength={4}
                                value={pin}
                                onChange={handlePinChange}
                                autoFocus
                            />
                            <Button type="submit" className="w-full">Desbloquear</Button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Utilidades ---
        const formatCurrency = (amount) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(amount);
        const formatCurrencyDetailed = (amount) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(amount);
        
        const formatDateShort = (dateString) => {
             if (!dateString) return '';
             const d = new Date(dateString);
             return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear().toString().substr(-2)}`;
        }

        // Función para redimensionar y comprimir imágenes antes de guardarlas
        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        // Tamaño máximo para miniatura/móvil
                        const MAX_WIDTH = 500;
                        const MAX_HEIGHT = 500;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        // Comprimir a JPEG calidad 0.7
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        };

        // --- App Principal ---
        function App() {
            // --- Estado de Seguridad ---
            const [isLocked, setIsLocked] = useState(() => {
                const session = sessionStorage.getItem('app_unlocked');
                return session !== 'true';
            });

            // Estados Data
            const [spotPrices, setSpotPrices] = useState(() => {
                const saved = localStorage.getItem('spotPrices');
                return saved ? JSON.parse(saved) : { gold: 2300.00, silver: 27.50, lastUpdated: null };
            });
            const [portfolio, setPortfolio] = useState(() => {
                const saved = localStorage.getItem('portfolio');
                return saved ? JSON.parse(saved) : [];
            });
            const [isLoadingPrices, setIsLoadingPrices] = useState(false);
            const [priceError, setPriceError] = useState(null);
            
            // UI States
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [isPriceModalOpen, setIsPriceModalOpen] = useState(false);
            const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false);
            const [imagePreviewModal, setImagePreviewModal] = useState(null); // URL de la imagen a ver en grande
            
            const [editingId, setEditingId] = useState(null); 
            const fileInputRef = useRef(null);
            const imageInputRef = useRef(null);
            
            const initialItemState = {
                name: '', metal: 'gold', weight: '', unit: 'oz', purchasePrice: '', purchaseDate: new Date().toISOString().split('T')[0], country: '', type: 'Moneda', image: null 
            };
            const [newItem, setNewItem] = useState(initialItemState);

            useEffect(() => localStorage.setItem('spotPrices', JSON.stringify(spotPrices)), [spotPrices]);
            useEffect(() => localStorage.setItem('portfolio', JSON.stringify(portfolio)), [portfolio]);
            useEffect(() => { if(!isLocked) fetchLivePrices(); }, [isLocked]);

            const fetchLivePrices = async () => {
                setIsLoadingPrices(true);
                setPriceError(null);
                try {
                    const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=pax-gold,kinesis-silver&vs_currencies=eur');
                    if (!response.ok) throw new Error('Error');
                    const data = await response.json();
                    if (data['pax-gold'] && data['kinesis-silver']) {
                        setSpotPrices({
                            gold: data['pax-gold'].eur,
                            silver: data['kinesis-silver'].eur,
                            lastUpdated: new Date().toISOString()
                        });
                    }
                } catch (err) {
                    console.error(err);
                    setPriceError("Usando precios guardados.");
                } finally {
                    setIsLoadingPrices(false);
                }
            };

            const stats = useMemo(() => {
                let totalInvested = 0, currentValue = 0, goldValue = 0, silverValue = 0;
                portfolio.forEach(item => {
                    const weightInOz = item.unit === 'g' ? item.weight * 0.0321507 : item.weight;
                    const spotPrice = item.metal === 'gold' ? spotPrices.gold : spotPrices.silver;
                    const itemVal = weightInOz * spotPrice;
                    totalInvested += parseFloat(item.purchasePrice || 0);
                    currentValue += itemVal;
                    if (item.metal === 'gold') goldValue += itemVal; else silverValue += itemVal;
                });
                const profitLoss = currentValue - totalInvested;
                const roi = totalInvested > 0 ? (profitLoss / totalInvested) * 100 : 0;
                return { totalInvested, currentValue, profitLoss, roi, goldValue, silverValue };
            }, [portfolio, spotPrices]);

            // --- Handlers de Imagen ---
            const handleImageChange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedBase64 = await compressImage(file);
                        setNewItem({ ...newItem, image: compressedBase64 });
                    } catch (error) {
                        alert("Error al procesar la imagen");
                    }
                }
            };

            const removeImage = () => {
                setNewItem({ ...newItem, image: null });
                if(imageInputRef.current) imageInputRef.current.value = "";
            };

            // --- Import / Export Logic ---
            const handleExportData = () => {
                const dataStr = JSON.stringify(portfolio, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = "backup_aurum_" + new Date().toISOString().split('T')[0] + ".json";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleImportClick = () => {
                fileInputRef.current.click();
            };

            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (Array.isArray(json)) {
                            if(confirm(`Se han encontrado ${json.length} monedas en el archivo. ¿Quieres reemplazar tu colección actual o añadirlas? \n\nAceptar = REEMPLAZAR TODO\nCancelar = AÑADIR A LO EXISTENTE`)) {
                                setPortfolio(json);
                            } else {
                                const newItems = json.map(item => ({...item, id: crypto.randomUUID()}));
                                setPortfolio([...portfolio, ...newItems]);
                            }
                            alert("Importación completada con éxito.");
                            setIsSettingsModalOpen(false);
                        } else {
                            alert("El archivo no tiene el formato correcto (debe ser una lista).");
                        }
                    } catch (err) {
                        alert("Error al leer el archivo JSON.");
                    }
                };
                reader.readAsText(file);
                event.target.value = null; // Reset
            };

            // --- CRUD Logic ---
            const handleSaveItem = (e) => {
                e.preventDefault();
                if (!newItem.name || !newItem.weight || !newItem.purchasePrice) return;
                if (editingId) {
                    setPortfolio(portfolio.map(item => item.id === editingId ? { ...newItem, id: editingId, weight: parseFloat(newItem.weight), purchasePrice: parseFloat(newItem.purchasePrice) } : item));
                } else {
                    const item = { id: crypto.randomUUID(), ...newItem, weight: parseFloat(newItem.weight), purchasePrice: parseFloat(newItem.purchasePrice) };
                    setPortfolio([item, ...portfolio]);
                }
                closeModal();
            };

            const openAddModal = () => { setEditingId(null); setNewItem(initialItemState); setIsAddModalOpen(true); };
            const openEditModal = (item) => { setEditingId(item.id); setNewItem({...item, country: item.country||'', type: item.type||'Moneda', image: item.image||null}); setIsAddModalOpen(true); };
            const closeModal = () => { setIsAddModalOpen(false); setEditingId(null); setNewItem(initialItemState); }
            const handleDeleteItem = (id) => { if (confirm('¿Borrar moneda?')) setPortfolio(portfolio.filter(item => item.id !== id)); };
            const handleUpdatePrices = (e) => { e.preventDefault(); const fd = new FormData(e.target); setSpotPrices({ gold: parseFloat(fd.get('goldPrice')), silver: parseFloat(fd.get('silverPrice')), lastUpdated: new Date().toISOString() }); setIsPriceModalOpen(false); };
            
            const handleUnlock = () => { setIsLocked(false); sessionStorage.setItem('app_unlocked', 'true'); };
            const handleLock = () => { setIsLocked(true); sessionStorage.removeItem('app_unlocked'); };

            if (isLocked) return <LockScreen onUnlock={handleUnlock} />;

            return (
                <div className="min-h-screen pb-20">
                    {/* Header */}
                    <header className="bg-slate-900 text-white shadow-lg sticky top-0 z-30">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                                <div className="w-8 h-8 bg-gradient-to-br from-amber-300 to-amber-600 rounded-full flex items-center justify-center text-amber-900 font-bold text-lg">JM</div>
                                <h1 className="text-xl font-bold tracking-tight">JMR Aurum<span className="text-slate-400">&</span>Argentum</h1>
                            </div>
                            <div className="flex items-center space-x-1">
                                <div onClick={() => setIsPriceModalOpen(true)} className="hidden sm:flex items-center space-x-2 bg-slate-800 px-3 py-1.5 rounded-full text-xs sm:text-sm border border-slate-700 cursor-pointer hover:bg-slate-700 transition mr-2">
                                    <span className="text-amber-400 font-bold">Au: {formatCurrency(spotPrices.gold)}</span>
                                    <span className="text-slate-600">|</span>
                                    <span className="text-slate-300 font-bold">Ag: {formatCurrency(spotPrices.silver)}</span>
                                </div>
                                <button onClick={fetchLivePrices} disabled={isLoadingPrices} className={`p-2 rounded-full bg-slate-800 border border-slate-700 text-slate-400 ${isLoadingPrices ? 'animate-spin text-amber-500' : 'hover:text-white'}`}>
                                    <Icons.RefreshCw size={16} />
                                </button>
                                <button onClick={() => setIsSettingsModalOpen(true)} className="p-2 rounded-full bg-slate-800 border border-slate-700 text-slate-400 hover:text-white hover:bg-slate-700 transition-colors">
                                    <Icons.Settings size={16} />
                                </button>
                                <button onClick={handleLock} className="p-2 ml-1 rounded-full bg-slate-800 border border-slate-700 text-slate-400 hover:text-white hover:bg-rose-900/30 hover:border-rose-800 transition-colors">
                                    <Icons.LogOut size={16} />
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-6 space-y-4 sm:space-y-6">
                        {/* Status Bar */}
                        <div className="flex justify-between items-center text-xs text-slate-500 px-1">
                            <span>{spotPrices.lastUpdated ? `Actualizado: ${new Date(spotPrices.lastUpdated).toLocaleTimeString()}` : 'Precios Manuales'}</span>
                            {priceError && <span className="text-rose-500 flex items-center"><Icons.AlertCircle size={12} className="mr-1"/> {priceError}</span>}
                        </div>

                        {/* KPI Cards: GRID DE 2 FILAS OPTIMIZADO */}
                        <div className="grid grid-cols-6 gap-2 sm:gap-4">
                            {/* Fila 1: 3 Elementos */}
                            <div className="col-span-2">
                                <StatCard 
                                    title="Invertido" 
                                    value={formatCurrency(stats.totalInvested)} 
                                    icon={Icons.Banknote} 
                                    colorClass="text-emerald-900" // Texto Verde Oscuro Intenso
                                    bgClass="bg-emerald-200"      // Fondo más saturado
                                />
                            </div>
                            <div className="col-span-2">
                                <StatCard 
                                    title="Valor Total" 
                                    value={formatCurrency(stats.currentValue)} 
                                    icon={Icons.Wallet} 
                                    colorClass="text-emerald-600" // Texto Verde Vivo
                                    bgClass="bg-emerald-100" 
                                />
                            </div>
                            <div className="col-span-2">
                                <StatCard 
                                    title="Ganancia" 
                                    value={formatCurrency(stats.profitLoss)} 
                                    subtext={`${stats.roi.toFixed(1)}%`} 
                                    trend={stats.profitLoss >= 0 ? 'up' : 'down'} 
                                    icon={Icons.TrendingUp} 
                                    colorClass={stats.profitLoss >= 0 ? "text-emerald-700" : "text-rose-600"} 
                                    bgClass={stats.profitLoss >= 0 ? "bg-emerald-100" : "bg-rose-100"}
                                />
                            </div>

                            {/* Fila 2: 2 Elementos */}
                            <div className="col-span-3">
                                <StatCard 
                                    title="Oro" 
                                    value={formatCurrency(stats.goldValue)} 
                                    icon={Icons.Coins} 
                                    colorClass="text-yellow-700" // Dorado Oscuro/Ámbar para que se lea mejor
                                    bgClass="bg-yellow-100" 
                                />
                            </div>
                            <div className="col-span-3">
                                <StatCard 
                                    title="Plata" 
                                    value={formatCurrency(stats.silverValue)} 
                                    icon={Icons.Coins} 
                                    colorClass="text-slate-600" // Plata con cuerpo
                                    bgClass="bg-slate-200" 
                                />
                            </div>
                        </div>

                        {/* Action Header */}
                        <div className="flex justify-between items-center pt-2 px-1">
                            <h2 className="text-lg sm:text-xl font-bold text-slate-800 flex items-center"><Icons.PieChart className="mr-2 text-slate-400" size={20}/> Mi Colección</h2>
                            <Button onClick={openAddModal} className="text-sm px-3 py-1.5"><Icons.Plus size={16} className="mr-1" /> Añadir</Button>
                        </div>

                        {/* Table */}
                        <Card className="overflow-hidden">
                            {portfolio.length === 0 ? (
                                <div className="text-center py-12 px-4">
                                    <div className="bg-slate-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Coins size={32} className="text-slate-300" /></div>
                                    <h3 className="text-lg font-medium text-slate-900">Colección vacía</h3>
                                    <p className="text-slate-500 text-sm mt-1 mb-6">Usa el botón de configuración para importar datos masivos.</p>
                                    <Button onClick={openAddModal} variant="secondary">Añadir Manualmente</Button>
                                </div>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left border-collapse">
                                        <thead>
                                            <tr className="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500">
                                                <th className="px-4 py-3 font-semibold w-16">Foto</th>
                                                <th className="px-4 py-3 font-semibold">Detalle Pieza</th>
                                                <th className="px-4 py-3 font-semibold text-right hidden sm:table-cell">Compra</th>
                                                <th className="px-4 py-3 font-semibold text-right">Valor</th>
                                                <th className="px-4 py-3 font-semibold text-right">P/G</th>
                                                <th className="px-4 py-3 text-center"></th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100 text-sm">
                                            {portfolio.map((item) => {
                                                const weightInOz = item.unit === 'g' ? item.weight * 0.0321507 : item.weight;
                                                const spotPrice = item.metal === 'gold' ? spotPrices.gold : spotPrices.silver;
                                                const currentVal = weightInOz * spotPrice;
                                                const profit = currentVal - item.purchasePrice;
                                                const percent = item.purchasePrice > 0 ? ((profit / item.purchasePrice) * 100).toFixed(1) : '0.0';

                                                return (
                                                    <tr key={item.id} className="hover:bg-slate-50 transition-colors">
                                                        <td className="px-4 py-3">
                                                            {item.image ? (
                                                                <div 
                                                                    className="w-10 h-10 rounded-full bg-slate-100 border border-slate-200 overflow-hidden cursor-pointer hover:ring-2 hover:ring-blue-400 transition"
                                                                    onClick={() => setImagePreviewModal(item.image)}
                                                                >
                                                                    <img src={item.image} alt={item.name} className="w-full h-full object-cover" />
                                                                </div>
                                                            ) : (
                                                                <div className="w-10 h-10 rounded-full bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-300">
                                                                    <Icons.Image size={16} />
                                                                </div>
                                                            )}
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            <div className="font-medium text-slate-900">{item.name}</div>
                                                            <div className="text-xs text-slate-500 flex flex-wrap gap-1 mt-0.5">
                                                                <span className="font-semibold">{item.metal === 'gold' ? 'Oro' : 'Plata'}</span>
                                                                <span>·</span>
                                                                <span>{item.weight} {item.unit}</span>
                                                                {item.type && <><span>·</span><span>{item.type}</span></>}
                                                                {item.country && <><span>·</span><span>{item.country}</span></>}
                                                                <span>·</span>
                                                                <span>{formatDateShort(item.purchaseDate)}</span>
                                                            </div>
                                                        </td>
                                                        <td className="px-4 py-3 text-right text-slate-500 font-mono hidden sm:table-cell">{formatCurrencyDetailed(item.purchasePrice)}</td>
                                                        <td className="px-4 py-3 text-right font-medium text-slate-900 font-mono">{formatCurrencyDetailed(currentVal)}</td>
                                                        <td className="px-4 py-3 text-right">
                                                            <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${profit >= 0 ? 'bg-emerald-100 text-emerald-800' : 'bg-rose-100 text-rose-800'}`}>
                                                                {profit >= 0 ? '+' : ''}{percent}%
                                                            </span>
                                                        </td>
                                                        <td className="px-4 py-3 text-center">
                                                            <div className="flex items-center justify-center space-x-1">
                                                                <button onClick={() => openEditModal(item)} className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded transition"><Icons.Edit size={16} /></button>
                                                                <button onClick={() => handleDeleteItem(item.id)} className="p-1.5 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded transition"><Icons.Trash2 size={16} /></button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </Card>
                    </main>

                    {/* --- MODALES --- */}

                    {/* Modal Añadir/Editar */}
                    <Modal isOpen={isAddModalOpen} onClose={closeModal} title={editingId ? "Editar Pieza" : "Nueva Pieza"}>
                        <form onSubmit={handleSaveItem} className="space-y-4">
                            {/* IMAGEN UPLOAD */}
                            <div className="flex justify-center mb-4">
                                <div className="relative group cursor-pointer" onClick={() => imageInputRef.current.click()}>
                                    <div className="w-24 h-24 rounded-xl border-2 border-dashed border-slate-300 flex flex-col items-center justify-center bg-slate-50 hover:bg-slate-100 transition overflow-hidden">
                                        {newItem.image ? (
                                            <img src={newItem.image} alt="Preview" className="w-full h-full object-cover" />
                                        ) : (
                                            <>
                                                <Icons.Camera size={24} className="text-slate-400 mb-1" />
                                                <span className="text-xs text-slate-500">Añadir Foto</span>
                                            </>
                                        )}
                                    </div>
                                    <input 
                                        type="file" 
                                        ref={imageInputRef} 
                                        onChange={handleImageChange} 
                                        accept="image/*" 
                                        className="hidden" 
                                    />
                                    {newItem.image && (
                                        <button 
                                            type="button"
                                            onClick={(e) => { e.stopPropagation(); removeImage(); }}
                                            className="absolute -top-2 -right-2 bg-rose-500 text-white rounded-full p-1 shadow-md hover:bg-rose-600"
                                        >
                                            <Icons.X size={12} />
                                        </button>
                                    )}
                                </div>
                            </div>

                            <div className="grid grid-cols-3 gap-3">
                                <div className="col-span-2">
                                    <label className="block text-sm font-medium text-slate-700 mb-1">Nombre</label>
                                    <input required type="text" className="w-full px-3 py-2 border rounded-lg outline-none focus:border-slate-900" value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">Tipo</label>
                                    <select className="w-full px-2 py-2 border rounded-lg outline-none bg-white" value={newItem.type} onChange={e => setNewItem({...newItem, type: e.target.value})}>
                                        <option value="Moneda">Moneda</option>
                                        <option value="Lingote">Lingote</option>
                                        <option value="Joyería">Joyería</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">Metal</label>
                                    <div className="flex space-x-2">
                                        <button type="button" onClick={() => setNewItem({...newItem, metal: 'gold'})} className={`flex-1 py-2 px-2 rounded-lg border text-sm font-medium ${newItem.metal === 'gold' ? 'bg-amber-100 border-amber-400 text-amber-800' : 'text-slate-600'}`}>Oro</button>
                                        <button type="button" onClick={() => setNewItem({...newItem, metal: 'silver'})} className={`flex-1 py-2 px-2 rounded-lg border text-sm font-medium ${newItem.metal === 'silver' ? 'bg-slate-200 border-slate-400 text-slate-800' : 'text-slate-600'}`}>Plata</button>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">País</label>
                                    <input type="text" className="w-full px-3 py-2 border rounded-lg outline-none focus:border-slate-900" value={newItem.country} onChange={e => setNewItem({...newItem, country: e.target.value})} />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Peso</label>
                                <div className="flex">
                                    <input required type="number" step="0.01" className="w-full px-3 py-2 border rounded-l-lg outline-none focus:border-slate-900" value={newItem.weight} onChange={e => setNewItem({...newItem, weight: e.target.value})} />
                                    <select className="bg-slate-100 border border-l-0 rounded-r-lg px-2 text-sm outline-none" value={newItem.unit} onChange={e => setNewItem({...newItem, unit: e.target.value})}><option value="oz">oz</option><option value="g">g</option></select>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">Fecha</label>
                                    <input required type="date" className="w-full px-3 py-2 border rounded-lg outline-none focus:border-slate-900" value={newItem.purchaseDate} onChange={e => setNewItem({...newItem, purchaseDate: e.target.value})} />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">Coste (€)</label>
                                    <input required type="number" step="0.01" className="w-full px-3 py-2 border rounded-lg outline-none focus:border-slate-900" value={newItem.purchasePrice} onChange={e => setNewItem({...newItem, purchasePrice: e.target.value})} />
                                </div>
                            </div>
                            <Button type="submit" className="w-full mt-4">{editingId ? "Actualizar" : "Guardar"}</Button>
                        </form>
                    </Modal>

                    {/* Modal Visualización Imagen */}
                    {imagePreviewModal && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-90 p-4" onClick={() => setImagePreviewModal(null)}>
                            <img src={imagePreviewModal} alt="Preview" className="max-w-full max-h-full rounded shadow-2xl" />
                            <button className="absolute top-4 right-4 text-white hover:text-slate-300">
                                <Icons.X size={32} />
                            </button>
                        </div>
                    )}

                    {/* Modal Configuración (Import/Export) */}
                    <Modal isOpen={isSettingsModalOpen} onClose={() => setIsSettingsModalOpen(false)} title="Gestión de Datos">
                        <div className="space-y-6">
                            <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                                <h4 className="font-semibold text-slate-800 mb-2 flex items-center"><Icons.Download size={18} className="mr-2"/> Copia de Seguridad</h4>
                                <p className="text-sm text-slate-600 mb-3">Descarga toda tu colección (imágenes incluidas) en un archivo.</p>
                                <Button onClick={handleExportData} variant="secondary" className="w-full">Exportar Datos (.json)</Button>
                            </div>

                            <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                                <h4 className="font-semibold text-slate-800 mb-2 flex items-center"><Icons.Upload size={18} className="mr-2"/> Restaurar / Importar</h4>
                                <p className="text-sm text-slate-600 mb-3">Carga un archivo de copia de seguridad.</p>
                                <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".json" />
                                <Button onClick={handleImportClick} variant="primary" className="w-full">Importar Datos</Button>
                            </div>
                            
                            <div className="border-t pt-4">
                                <h4 className="font-semibold text-rose-800 mb-2">Zona de Peligro</h4>
                                <Button onClick={() => { if(confirm("¿Estás seguro de BORRAR TODA la colección? No se puede deshacer.")) setPortfolio([]); setIsSettingsModalOpen(false); }} variant="danger" className="w-full">Borrar Todo</Button>
                            </div>
                        </div>
                    </Modal>

                    {/* Modal Precio Spot */}
                    <Modal isOpen={isPriceModalOpen} onClose={() => setIsPriceModalOpen(false)} title="Ajuste Manual (€/oz)">
                        <form onSubmit={handleUpdatePrices} className="space-y-4">
                            <div><label className="text-sm font-medium">Oro</label><input name="goldPrice" type="number" step="0.01" defaultValue={spotPrices.gold} className="w-full px-3 py-2 border rounded-lg font-mono" /></div>
                            <div><label className="text-sm font-medium">Plata</label><input name="silverPrice" type="number" step="0.01" defaultValue={spotPrices.silver} className="w-full px-3 py-2 border rounded-lg font-mono" /></div>
                            <Button type="submit" className="w-full mt-2">Actualizar Precios</Button>
                        </form>
                    </Modal>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
