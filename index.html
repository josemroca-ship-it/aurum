<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JMR Aurum & Argentum</title>
    
    <!-- Favicon: Lingote de Oro -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath d='M10 20 L18 8 L46 8 L54 20 Z' fill='%23FFD700' stroke='%23B8860B' stroke-width='2'/%3E%3Crect x='10' y='20' width='44' height='24' fill='%23FFD700' stroke='%23B8860B' stroke-width='2'/%3E%3Ctext x='32' y='38' font-family='sans-serif' font-size='10' text-anchor='middle' fill='%23B8860B' font-weight='bold'%3EAU%3C/text%3E%3C/svg%3E">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body class="bg-slate-50 select-none">
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        //  ZONA DE CONFIGURACI√ìN
        // ==========================================
        
        // 1. PIN de Seguridad (SHA-256 de "0000")
        const APP_PIN_HASH = "9c55b07c46330c6621ef6b2fea5f2ceb51acb3b7d68258580716e0937d88a47d"; 

        // 2. GOLDAPI.IO (Precios Reales)
        const GOLD_API_KEY = "goldapi-980ssmjfmbl3k-io"; 

        // 3. FIREBASE CONFIG (Sincronizaci√≥n Nube)
        // Copia esto desde tu consola de Firebase
        const firebaseConfig = {
            // apiKey: "...",
            // authDomain: "...",
            // projectId: "...",
            // storageBucket: "...",
            // messagingSenderId: "...",
            // appId: "..."
        };
        // ==========================================

        let db = null;
        let auth = null;
        
        // Detectar si Firebase est√° configurado (si tiene claves reales y no las de ejemplo)
        const isFirebaseReady = Object.keys(firebaseConfig).length > 0 && !firebaseConfig.apiKey?.startsWith("...");

        if (isFirebaseReady) {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                auth = firebase.auth();
                // Habilitar cach√© offline
                db.enablePersistence({ synchronizeTabs: true }).catch(err => console.log("Persistencia:", err.code));
            } catch (e) {
                console.error("Error inicializando Firebase:", e);
            }
        }

        // --- Iconos SVG ---
        const Icon = ({ path, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Wallet: (props) => <Icon {...props} path={<><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4" /><path d="M3 5v14a2 2 0 0 0 2 2h16v-5" /><path d="M18 12a2 2 0 0 0 0 4h4v-4Z" /></>} />,
            Banknote: (props) => <Icon {...props} path={<><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></>} />,
            TrendingUp: (props) => <Icon {...props} path={<><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></>} />,
            TrendingDown: (props) => <Icon {...props} path={<><polyline points="23 18 13.5 8.5 8.5 13.5 1 6" /><polyline points="17 18 23 18 23 12" /></>} />,
            ArrowUpRight: (props) => <Icon {...props} path={<><line x1="7" y1="17" x2="17" y2="7" /><polyline points="7 7 17 7 17 17" /></>} />,
            ArrowDownRight: (props) => <Icon {...props} path={<><line x1="7" y1="7" x2="17" y2="17" /><polyline points="17 7 17 17 7 17" /></>} />,
            Coins: (props) => <Icon {...props} path={<><circle cx="8" cy="8" r="6" /><path d="M18.09 10.37A6 6 0 1 1 10.34 18" /><path d="M7 6h1v4" /><path d="m16.71 13.88.7.71-2.82 2.82" /></>} />,
            PieChart: (props) => <Icon {...props} path={<><path d="M21.21 15.89A10 10 0 1 1 8 2.83" /><path d="M22 12A10 10 0 0 0 12 2v10z" /></>} />,
            Plus: (props) => <Icon {...props} path={<><path d="M5 12h14" /><path d="M12 5v14" /></>} />,
            Trash2: (props) => <Icon {...props} path={<><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></>} />,
            Edit: (props) => <Icon {...props} path={<><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></>} />,
            RefreshCw: (props) => <Icon {...props} path={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" /></>} />,
            AlertCircle: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></>} />,
            X: (props) => <Icon {...props} path={<><path d="M18 6 6 18" /><path d="m6 6 12 12" /></>} />,
            Lock: (props) => <Icon {...props} path={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>} />,
            LogOut: (props) => <Icon {...props} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" x2="9" y1="12" y2="12" /></>} />,
            Download: (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></>} />,
            Upload: (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></>} />,
            Settings: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></>} />,
            Camera: (props) => <Icon {...props} path={<><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>} />,
            Image: (props) => <Icon {...props} path={<><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><circle cx="8.5" cy="8.5" r="1.5" /><polyline points="21 15 16 10 5 21" /></>} />,
            Cloud: (props) => <Icon {...props} path={<><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></>} />,
            ExternalLink: (props) => <Icon {...props} path={<><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" y1="14" x2="21" y2="3" /></>} />,
        };

        const { useState, useEffect, useMemo, useRef } = React;

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>
                {children}
            </div>
        );

        const StatCard = ({ title, value, subtext, trend, icon: IconComponent, colorClass = "text-slate-600", bgClass = "bg-slate-100" }) => (
            <Card className="p-3 sm:p-4 flex flex-col justify-between h-full">
                <div className="flex justify-between items-start mb-2">
                    <p className="text-[10px] sm:text-xs font-bold uppercase tracking-wider text-slate-500 truncate pr-2 mt-1">{title}</p>
                    <div className={`p-2 rounded-lg shrink-0 ${bgClass}`}>
                        <IconComponent size={20} className={colorClass} />
                    </div>
                </div>
                <div>
                    <h3 className={`text-base sm:text-2xl font-bold leading-tight truncate ${colorClass}`}>{value}</h3>
                    {subtext && (
                        <div className="mt-1">
                             <p className={`text-[10px] sm:text-xs font-medium flex items-center ${trend === 'up' ? 'text-emerald-600' : trend === 'down' ? 'text-rose-600' : 'text-slate-500'}`}>
                                {trend === 'up' ? <Icons.TrendingUp size={10} className="mr-0.5 shrink-0" /> : trend === 'down' ? <Icons.TrendingDown size={10} className="mr-0.5 shrink-0" /> : null}
                                <span className="truncate">{subtext}</span>
                            </p>
                        </div>
                    )}
                </div>
            </Card>
        );

        const Button = ({ children, onClick, variant = 'primary', className = '', ...props }) => {
            const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-offset-1 disabled:opacity-50 disabled:cursor-not-allowed select-none active:scale-95";
            const variants = {
                primary: "bg-slate-900 text-white hover:bg-slate-800 focus:ring-slate-900",
                secondary: "bg-white text-slate-700 border border-slate-300 hover:bg-slate-50 focus:ring-slate-200",
                danger: "bg-rose-50 text-rose-600 hover:bg-rose-100 focus:ring-rose-200",
                gold: "bg-amber-400 text-amber-950 hover:bg-amber-500 focus:ring-amber-400"
            };
            return (
                <button 
                    onClick={onClick} 
                    className={`${baseStyle} ${variants[variant]} ${className}`}
                    {...props}
                >
                    {children}
                </button>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm p-4 animate-[fadeIn_0.2s_ease-out]">
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden animate-[zoomIn_0.2s_ease-out] flex flex-col max-h-[90vh]">
                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 shrink-0">
                            <h3 className="text-lg font-bold text-slate-800">{title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><Icons.X size={20}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const LockScreen = ({ onUnlock }) => {
            const [pin, setPin] = useState("");
            const [error, setError] = useState(false);

            const verifyPin = async (inputPin) => {
                const encoder = new TextEncoder();
                const data = encoder.encode(inputPin);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return hashHex === APP_PIN_HASH;
            };

            const handlePinChange = async (e) => {
                const newPin = e.target.value;
                setPin(newPin);
                setError(false);
                if (newPin.length === 4) {
                    const isValid = await verifyPin(newPin);
                    if (isValid) { onUnlock(); } else { setError(true); if (navigator.vibrate) navigator.vibrate(200); }
                }
            };

            const handleSubmit = async (e) => { e.preventDefault(); const isValid = await verifyPin(pin); if (isValid) { onUnlock(); } else { setError(true); setPin(""); if (navigator.vibrate) navigator.vibrate(200); } };

            return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-xs rounded-2xl p-8 shadow-2xl text-center">
                        <div className="w-16 h-16 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto mb-6"><Icons.Lock size={32} /></div>
                        <h2 className="text-xl font-bold text-slate-900 mb-2">Acceso Restringido</h2>
                        <p className="text-slate-500 text-sm mb-6">Introduce el PIN de seguridad</p>
                        <form onSubmit={handleSubmit}>
                            <input type="password" pattern="[0-9]*" inputMode="numeric" className={`w-full text-center text-3xl tracking-[0.5em] font-bold py-3 border-b-2 outline-none mb-6 transition-colors ${error ? 'border-rose-500 text-rose-600' : 'border-slate-200 text-slate-800 focus:border-slate-900'}`} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxLength={4} value={pin} onChange={handlePinChange} autoFocus />
                            <Button type="submit" className="w-full">Desbloquear</Button>
                        </form>
                    </div>
                </div>
            );
        };

        const formatCurrency = (amount) => new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(amount);
        const formatCurrencyDetailed = (amount) => new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(amount);
        const formatDateShort = (dateString) => { if (!dateString) return ''; const d = new Date(dateString); return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear().toString().substr(-2)}`; }
        const getCountryFlag = (countryName) => {
            if (!countryName) return "üåç"; const lower = countryName.toLowerCase().trim();
            if (lower.includes("sud√°frica") || lower.includes("sudafrica") || lower.includes("africa")) return "üáøüá¶";
            if (lower.includes("usa") || lower.includes("estados unidos") || lower.includes("eeuu") || lower.includes("eagle")) return "üá∫üá∏";
            if (lower.includes("canad√°") || lower.includes("canada") || lower.includes("maple")) return "üá®üá¶";
            if (lower.includes("china") || lower.includes("panda")) return "üá®üá≥";
            if (lower.includes("australia") || lower.includes("canguro") || lower.includes("koala")) return "üá¶üá∫";
            if (lower.includes("austria") || lower.includes("filarm√≥nica") || lower.includes("philharmonic")) return "üá¶üáπ";
            if (lower.includes("uk") || lower.includes("reino unido") || lower.includes("inglaterra") || lower.includes("britannia")) return "üá¨üáß";
            if (lower.includes("m√©xico") || lower.includes("mexico") || lower.includes("libertad")) return "üá≤üáΩ";
            if (lower.includes("espa√±a") || lower.includes("spain")) return "üá™üá∏";
            if (lower.includes("suiza") || lower.includes("switzerland")) return "üá®üá≠";
            if (lower.includes("alemania") || lower.includes("germany")) return "üá©üá™";
            if (lower.includes("francia") || lower.includes("france")) return "üá´üá∑";
            if (lower.includes("armenia")) return "üá¶üá≤";
            return "üåç"; 
        };
        const compressImage = (file) => { return new Promise((resolve) => { const reader = new FileReader(); reader.onload = (event) => { const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); const MAX_WIDTH = 500; const MAX_HEIGHT = 500; let width = img.width; let height = img.height; if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } } else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } } canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/jpeg', 0.7)); }; img.src = event.target.result; }; reader.readAsDataURL(file); }); };

        const normalizePassphrase = (p) => p ? p.trim().toLowerCase() : "";
        const generateDocId = async (rawPass) => {
            const pass = normalizePassphrase(rawPass);
            if (!pass) return null;
            if (window.crypto && window.crypto.subtle) {
                const encoder = new TextEncoder();
                const hashBuffer = await crypto.subtle.digest('SHA-256', encoder.encode(pass));
                return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
            } else {
                let hash = 0;
                for (let i = 0; i < pass.length; i++) {
                    const char = pass.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash |= 0;
                }
                return "insecure_" + Math.abs(hash).toString(16);
            }
        };

        // --- App Principal ---
        function App() {
            const [isLocked, setIsLocked] = useState(() => { const session = sessionStorage.getItem('app_unlocked'); return session !== 'true'; });
            const [spotPrices, setSpotPrices] = useState(() => { const saved = localStorage.getItem('spotPrices'); return saved ? JSON.parse(saved) : { gold: 2300.00, silver: 27.50, goldTrend: 'flat', silverTrend: 'flat', lastUpdated: null }; });
            const [portfolio, setPortfolio] = useState(() => { const saved = localStorage.getItem('portfolio'); return saved ? JSON.parse(saved) : []; });
            const [isLoadingPrices, setIsLoadingPrices] = useState(false);
            const [priceError, setPriceError] = useState(null);
            
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [isPriceModalOpen, setIsPriceModalOpen] = useState(false);
            const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false);
            const [imagePreviewModal, setImagePreviewModal] = useState(null);
            
            const [editingId, setEditingId] = useState(null); 
            const fileInputRef = useRef(null);
            const imageInputRef = useRef(null);
            
            const [syncPassphrase, setSyncPassphrase] = useState(() => localStorage.getItem('sync_passphrase') || "");
            const [isSyncEnabled, setIsSyncEnabled] = useState(false);
            const [syncStatus, setSyncStatus] = useState("disconnected"); 
            const [syncMessage, setSyncMessage] = useState("");
            
            const isRemoteUpdate = useRef(false);

            const initialItemState = {
                name: '', metal: 'gold', weight: '', unit: 'oz', purchasePrice: '', purchaseDate: new Date().toISOString().split('T')[0], country: '', type: 'Moneda', image: null 
            };
            const [newItem, setNewItem] = useState(initialItemState);

            useEffect(() => {
                if (isFirebaseReady && syncPassphrase) {
                    auth.signInAnonymously()
                        .then(() => enableSync(syncPassphrase))
                        .catch(err => {
                            console.error("Auth Fail:", err);
                            setSyncStatus("error");
                            
                            if (err.code === 'auth/operation-not-allowed' || err.code === 'auth/configuration-not-found') {
                                setSyncMessage("Error: Debes habilitar 'An√≥nimo' en Firebase Auth.");
                            } else {
                                setSyncMessage("Error de autenticaci√≥n: " + err.message);
                            }
                        });
                }
            }, []);

            useEffect(() => localStorage.setItem('spotPrices', JSON.stringify(spotPrices)), [spotPrices]);
            useEffect(() => {
                localStorage.setItem('portfolio', JSON.stringify(portfolio));
                if (isSyncEnabled && isFirebaseReady && db && syncPassphrase) {
                    if (isRemoteUpdate.current) {
                        isRemoteUpdate.current = false; 
                    } else {
                        pushToCloud();
                    }
                }
            }, [portfolio, isSyncEnabled]);

            useEffect(() => { if(!isLocked) fetchLivePrices(); }, [isLocked]);

            const enableSync = async (rawPass) => {
                if (!isFirebaseReady || !rawPass) return;
                const docId = await generateDocId(rawPass);
                
                setIsSyncEnabled(true);
                setSyncStatus("syncing");
                setSyncMessage("Conectando con la base de datos...");
                localStorage.setItem('sync_passphrase', rawPass);

                db.collection('portfolios').doc(docId).onSnapshot((doc) => {
                    if (doc.exists) {
                        const cloudData = doc.data();
                        const localStr = JSON.stringify(portfolio);
                        const cloudStr = JSON.stringify(cloudData.items);
                        
                        if (localStr !== cloudStr) {
                            console.log("Recibiendo datos frescos de la nube...");
                            isRemoteUpdate.current = true;
                            setPortfolio(cloudData.items || []);
                        }
                        setSyncStatus("connected");
                        setSyncMessage("Sincronizado");
                    } else {
                        setSyncMessage("Creando respaldo en la nube...");
                        pushToCloud(docId);
                    }
                }, (error) => {
                    console.error("Sync Error:", error);
                    setSyncStatus("error");
                    if (error.code === 'permission-denied') {
                        setSyncMessage("PERMISSION_DENIED");
                    } else {
                        setSyncMessage("Error de conexi√≥n: " + error.message);
                    }
                });
            };

            const pushToCloud = async (overrideDocId = null) => {
                if (!isFirebaseReady) return;
                let docId = overrideDocId;
                if (!docId) docId = await generateDocId(syncPassphrase);

                db.collection('portfolios').doc(docId).set({
                    items: portfolio,
                    lastUpdated: new Date().toISOString()
                }, { merge: true })
                .then(() => {
                    setSyncStatus("connected");
                    setSyncMessage("Guardado en nube");
                })
                .catch(err => {
                    console.error("Push Error", err);
                    setSyncStatus("error");
                    setSyncMessage("Fallo al guardar: " + err.code);
                });
            };

            const handleSyncSubmit = (e) => {
                e.preventDefault();
                const pass = e.target.syncPass.value;
                setSyncPassphrase(pass);
                auth.signInAnonymously()
                    .then(() => enableSync(pass))
                    .catch(err => {
                        console.error(err);
                        if (err.code === 'auth/configuration-not-found' || err.code === 'auth/admin-restricted-operation' || err.code === 'auth/operation-not-allowed') {
                            alert("‚ö†Ô∏è Error de Configuraci√≥n en Firebase:\n\nNo has habilitado la 'Autenticaci√≥n An√≥nima'.\n\n1. Ve a la Consola de Firebase -> Autenticaci√≥n.\n2. Pesta√±a 'Sign-in method' (M√©todo de inicio de sesi√≥n).\n3. Activa 'An√≥nimo'.");
                        } else {
                            alert("Error login: " + err.message);
                        }
                    });
            };

            const openConsole = () => {
                const projectId = firebaseConfig.projectId;
                const url = projectId 
                    ? `https://console.firebase.google.com/project/${projectId}/firestore/rules` 
                    : "https://console.firebase.google.com/";
                window.open(url, '_blank');
            };

            const fetchLivePrices = async () => {
                if (!GOLD_API_KEY || GOLD_API_KEY === "PON_AQUI_TU_API_KEY") {
                    setPriceError("Falta API Key GoldAPI");
                    return;
                }

                setIsLoadingPrices(true); setPriceError(null);
                
                const headers = { 'x-access-token': GOLD_API_KEY, 'Content-Type': 'application/json' };
                
                try {
                    const resGold = await fetch('https://www.goldapi.io/api/XAU/EUR', { headers });
                    if (!resGold.ok) throw new Error('Error GoldAPI Oro');
                    const dataGold = await resGold.json();

                    const resSilver = await fetch('https://www.goldapi.io/api/XAG/EUR', { headers });
                    if (!resSilver.ok) throw new Error('Error GoldAPI Plata');
                    const dataSilver = await resSilver.json();

                    // Calculate trend based on 'ch' (change) field from GoldAPI
                    // dataGold.ch > 0 -> up, < 0 -> down
                    const goldTrend = dataGold.ch > 0 ? 'up' : (dataGold.ch < 0 ? 'down' : 'flat');
                    const silverTrend = dataSilver.ch > 0 ? 'up' : (dataSilver.ch < 0 ? 'down' : 'flat');

                    const newPrices = { 
                        gold: dataGold.price, 
                        silver: dataSilver.price, 
                        goldTrend,
                        silverTrend,
                        lastUpdated: new Date().toISOString() 
                    };

                    setSpotPrices(newPrices);

                } catch (err) { 
                    console.error(err); 
                    setPriceError("Error conectando a GoldAPI."); 
                } finally { 
                    setIsLoadingPrices(false); 
                }
            };

            const stats = useMemo(() => {
                let totalInvested = 0, currentValue = 0, goldValue = 0, silverValue = 0;
                portfolio.forEach(item => {
                    const weightInOz = item.unit === 'g' ? item.weight * 0.0321507 : item.weight;
                    const spotPrice = item.metal === 'gold' ? spotPrices.gold : spotPrices.silver;
                    const itemVal = weightInOz * spotPrice;
                    totalInvested += parseFloat(item.purchasePrice || 0);
                    currentValue += itemVal;
                    if (item.metal === 'gold') goldValue += itemVal; else silverValue += itemVal;
                });
                const profitLoss = currentValue - totalInvested;
                const roi = totalInvested > 0 ? (profitLoss / totalInvested) * 100 : 0;
                return { totalInvested, currentValue, profitLoss, roi, goldValue, silverValue };
            }, [portfolio, spotPrices]);

            const handleImageChange = async (e) => { const file = e.target.files[0]; if (file) { try { const compressedBase64 = await compressImage(file); setNewItem({ ...newItem, image: compressedBase64 }); } catch (error) { alert("Error imagen"); } } };
            const removeImage = () => { setNewItem({ ...newItem, image: null }); if(imageInputRef.current) imageInputRef.current.value = ""; };
            const handleExportData = () => { const dataStr = JSON.stringify(portfolio, null, 2); const blob = new Blob([dataStr], { type: "application/json" }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.download = "backup_aurum_" + new Date().toISOString().split('T')[0] + ".json"; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const handleImportClick = () => { fileInputRef.current.click(); };
            const handleFileChange = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const json = JSON.parse(e.target.result); if (Array.isArray(json)) { if(confirm(`Cargar ${json.length} monedas?`)) { setPortfolio(json); } alert("Importado."); setIsSettingsModalOpen(false); } } catch (err) { alert("Error JSON"); } }; reader.readAsText(file); event.target.value = null; };
            const handleSaveItem = (e) => { e.preventDefault(); if (!newItem.name || !newItem.weight || !newItem.purchasePrice) return; if (editingId) { setPortfolio(portfolio.map(item => item.id === editingId ? { ...newItem, id: editingId, weight: parseFloat(newItem.weight), purchasePrice: parseFloat(newItem.purchasePrice) } : item)); } else { const item = { id: crypto.randomUUID(), ...newItem, weight: parseFloat(newItem.weight), purchasePrice: parseFloat(newItem.purchasePrice) }; setPortfolio([item, ...portfolio]); } closeModal(); };
            const openAddModal = () => { setEditingId(null); setNewItem(initialItemState); setIsAddModalOpen(true); };
            const openEditModal = (item) => { setEditingId(item.id); setNewItem({...item, country: item.country||'', type: item.type||'Moneda', image: item.image||null}); setIsAddModalOpen(true); };
            const closeModal = () => { setIsAddModalOpen(false); setEditingId(null); setNewItem(initialItemState); }
            const handleDeleteItem = (id) => { if (confirm('¬øBorrar?')) setPortfolio(portfolio.filter(item => item.id !== id)); };
            const handleUpdatePrices = (e) => { e.preventDefault(); const fd = new FormData(e.target); setSpotPrices({ gold: parseFloat(fd.get('goldPrice')), silver: parseFloat(fd.get('silverPrice')), lastUpdated: new Date().toISOString() }); setIsPriceModalOpen(false); };
            const handleUnlock = () => { setIsLocked(false); sessionStorage.setItem('app_unlocked', 'true'); };
            const handleLock = () => { setIsLocked(true); sessionStorage.removeItem('app_unlocked'); };

            if (isLocked) return <LockScreen onUnlock={handleUnlock} />;

            return (
                <div className="min-h-screen pb-20">
                    <header className="bg-slate-900 text-white shadow-lg sticky top-0 z-30">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                                <div className="w-8 h-8 bg-gradient-to-br from-amber-300 to-amber-600 rounded-full flex items-center justify-center text-amber-900 font-bold text-lg">JM</div>
                                <h1 className="text-xl font-bold tracking-tight">JMR Aurum<span className="text-slate-400">&</span>Argentum</h1>
                            </div>
                            <div className="flex items-center space-x-1">
                                <div onClick={() => setIsPriceModalOpen(true)} className="hidden sm:flex items-center space-x-2 bg-slate-800 px-3 py-1.5 rounded-full text-xs sm:text-sm border border-slate-700 cursor-pointer hover:bg-slate-700 transition mr-2">
                                    <div className="flex items-center space-x-1 mr-2">
                                        <span className="text-amber-400 font-bold">Au: {formatCurrency(spotPrices.gold)}</span>
                                        {spotPrices.goldTrend === 'up' && <Icons.ArrowUpRight size={14} className="text-emerald-400" />}
                                        {spotPrices.goldTrend === 'down' && <Icons.ArrowDownRight size={14} className="text-rose-400" />}
                                    </div>
                                    <span className="text-slate-600">|</span>
                                    <div className="flex items-center space-x-1 ml-2">
                                        <span className="text-slate-300 font-bold">Ag: {formatCurrency(spotPrices.silver)}</span>
                                        {spotPrices.silverTrend === 'up' && <Icons.ArrowUpRight size={14} className="text-emerald-400" />}
                                        {spotPrices.silverTrend === 'down' && <Icons.ArrowDownRight size={14} className="text-rose-400" />}
                                    </div>
                                </div>
                                <button onClick={fetchLivePrices} disabled={isLoadingPrices} className={`p-2 rounded-full bg-slate-800 border border-slate-700 text-slate-400 ${isLoadingPrices ? 'animate-spin text-amber-500' : 'hover:text-white'}`}>
                                    <Icons.RefreshCw size={16} />
                                </button>
                                <button onClick={() => setIsSettingsModalOpen(true)} className={`p-2 rounded-full bg-slate-800 border border-slate-700 hover:text-white hover:bg-slate-700 transition-colors relative ${isSyncEnabled && syncStatus === 'connected' ? 'text-emerald-400 border-emerald-500/50' : (syncStatus === 'error' ? 'text-rose-500 border-rose-500' : 'text-slate-400')}`}>
                                    <Icons.Settings size={16} />
                                    {isSyncEnabled && syncStatus === 'connected' && <span className="absolute top-0 right-0 w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>}
                                    {syncStatus === 'error' && <span className="absolute top-0 right-0 w-2 h-2 bg-rose-500 rounded-full animate-pulse"></span>}
                                </button>
                                <button onClick={handleLock} className="p-2 ml-1 rounded-full bg-slate-800 border border-slate-700 text-slate-400 hover:text-white hover:bg-rose-900/30 hover:border-rose-800 transition-colors">
                                    <Icons.LogOut size={16} />
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-6 space-y-4 sm:space-y-6">
                        <div className="flex justify-between items-center text-xs text-slate-500 px-1">
                            <span>{spotPrices.lastUpdated ? `Actualizado: ${new Date(spotPrices.lastUpdated).toLocaleTimeString()}` : 'Precios Manuales'}</span>
                            {priceError && <span className="text-rose-500 flex items-center"><Icons.AlertCircle size={12} className="mr-1"/> {priceError}</span>}
                        </div>

                        <div className="grid grid-cols-6 gap-2 sm:gap-4">
                            <div className="col-span-2"><StatCard title="Invertido" value={formatCurrency(stats.totalInvested)} icon={Icons.Banknote} colorClass="text-emerald-900" bgClass="bg-emerald-200" /></div>
                            <div className="col-span-2"><StatCard title="Valor Total" value={formatCurrency(stats.currentValue)} icon={Icons.Wallet} colorClass="text-emerald-600" bgClass="bg-emerald-100" /></div>
                            <div className="col-span-2"><StatCard title="Ganancia" value={formatCurrency(stats.profitLoss)} subtext={`${stats.roi.toFixed(1)}%`} trend={stats.profitLoss >= 0 ? 'up' : 'down'} icon={Icons.TrendingUp} colorClass={stats.profitLoss >= 0 ? "text-emerald-700" : "text-rose-600"} bgClass={stats.profitLoss >= 0 ? "bg-emerald-100" : "bg-rose-100"} /></div>
                            <div className="col-span-3"><StatCard title="Oro" value={formatCurrency(stats.goldValue)} icon={Icons.Coins} colorClass="text-yellow-700" bgClass="bg-yellow-100" /></div>
                            <div className="col-span-3"><StatCard title="Plata" value={formatCurrency(stats.silverValue)} icon={Icons.Coins} colorClass="text-slate-600" bgClass="bg-slate-200" /></div>
                        </div>

                        <div className="flex justify-between items-center pt-2 px-1">
                            <h2 className="text-lg sm:text-xl font-bold text-slate-800 flex items-center"><Icons.PieChart className="mr-2 text-slate-400" size={20}/> Mi Colecci√≥n</h2>
                            <Button onClick={openAddModal} className="text-sm px-3 py-1.5"><Icons.Plus size={16} className="mr-1" /> A√±adir</Button>
                        </div>

                        <Card className="overflow-hidden">
                            {portfolio.length === 0 ? (
                                <div className="text-center py-12 px-4">
                                    <div className="bg-slate-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Coins size={32} className="text-slate-300" /></div>
                                    <h3 className="text-lg font-medium text-slate-900">Colecci√≥n vac√≠a</h3>
                                    <p className="text-slate-500 text-sm mt-1 mb-6">Usa el bot√≥n de configuraci√≥n para importar datos.</p>
                                    <Button onClick={openAddModal} variant="secondary">A√±adir Manualmente</Button>
                                </div>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left border-collapse">
                                        <thead>
                                            <tr className="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500">
                                                <th className="px-4 py-3 font-semibold w-16">Foto</th>
                                                <th className="px-4 py-3 font-semibold">Detalle Pieza</th>
                                                <th className="px-4 py-3 font-semibold w-12 text-center">Pa√≠s</th>
                                                <th className="px-4 py-3 font-semibold text-right hidden sm:table-cell">Compra</th>
                                                <th className="px-4 py-3 font-semibold text-right">Valor</th>
                                                <th className="px-4 py-3 font-semibold text-right">P/G</th>
                                                <th className="px-4 py-3 text-center"></th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100 text-sm">
                                            {portfolio.map((item) => {
                                                const weightInOz = item.unit === 'g' ? item.weight * 0.0321507 : item.weight;
                                                const spotPrice = item.metal === 'gold' ? spotPrices.gold : spotPrices.silver;
                                                const currentVal = weightInOz * spotPrice;
                                                const profit = currentVal - item.purchasePrice;
                                                const percent = item.purchasePrice > 0 ? ((profit / item.purchasePrice) * 100).toFixed(1) : '0.0';

                                                return (
                                                    <tr key={item.id} className="hover:bg-slate-50 transition-colors">
                                                        <td className="px-4 py-3">
                                                            {item.image ? (
                                                                <div 
                                                                    className="w-10 h-10 rounded-full bg-slate-100 border border-slate-200 overflow-hidden cursor-pointer hover:ring-2 hover:ring-blue-400 transition"
                                                                    onClick={() => setImagePreviewModal(item.image)}
                                                                >
                                                                    <img src={item.image} alt={item.name} className="w-full h-full object-cover" />
                                                                </div>
                                                            ) : (
                                                                <div className="w-10 h-10 rounded-full bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-300"><Icons.Image size={16} /></div>
                                                            )}
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            <div className="font-medium text-slate-900">{item.name}</div>
                                                            <div className="text-xs text-slate-500 flex flex-wrap gap-1 mt-0.5">
                                                                <span className="font-semibold">{item.metal === 'gold' ? 'Oro' : 'Plata'}</span>
                                                                <span>¬∑</span><span>{item.weight} {item.unit}</span>
                                                                {item.type && <><span>¬∑</span><span>{item.type}</span></>}
                                                                <span>¬∑</span><span>{formatDateShort(item.purchaseDate)}</span>
                                                            </div>
                                                        </td>
                                                        <td className="px-4 py-3 text-center text-xl">{getCountryFlag(item.country)}</td>
                                                        <td className="px-4 py-3 text-right text-slate-500 font-mono hidden sm:table-cell">{formatCurrencyDetailed(item.purchasePrice)}</td>
                                                        <td className="px-4 py-3 text-right font-medium text-slate-900 font-mono">{formatCurrencyDetailed(currentVal)}</td>
                                                        <td className="px-4 py-3 text-right">
                                                            <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${profit >= 0 ? 'bg-emerald-100 text-emerald-800' : 'bg-rose-100 text-rose-800'}`}>
                                                                {profit >= 0 ? '+' : ''}{percent}%
                                                            </span>
                                                        </td>
                                                        <td className="px-4 py-3 text-center">
                                                            <div className="flex items-center justify-center space-x-1">
                                                                <button onClick={() => openEditModal(item)} className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded transition"><Icons.Edit size={16} /></button>
                                                                <button onClick={() => handleDeleteItem(item.id)} className="p-1.5 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded transition"><Icons.Trash2 size={16} /></button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </Card>
                    </main>

                    {imagePreviewModal && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-90 p-4" onClick={() => setImagePreviewModal(null)}>
                            <img src={imagePreviewModal} alt="Preview" className="max-w-full max-h-full rounded shadow-2xl" />
                            <button className="absolute top-4 right-4 text-white hover:text-slate-300"><Icons.X size={32} /></button>
                        </div>
                    )}

                    <Modal isOpen={isAddModalOpen} onClose={closeModal} title={editingId ? "Editar Pieza" : "Nueva Pieza"}>
                        <form onSubmit={handleSaveItem} className="space-y-4">
                            <div className="flex justify-center mb-4">
                                <div className="relative group cursor-pointer" onClick={() => imageInputRef.current.click()}>
                                    <div className="w-24 h-24 rounded-xl border-2 border-dashed border-slate-300 flex flex-col items-center justify-center bg-slate-50 hover:bg-slate-100 transition overflow-hidden">
                                        {newItem.image ? <img src={newItem.image} alt="Preview" className="w-full h-full object-cover" /> : <><Icons.Camera size={24} className="text-slate-400 mb-1" /><span className="text-xs text-slate-500">A√±adir Foto</span></>}
                                    </div>
                                    <input type="file" ref={imageInputRef} onChange={handleImageChange} accept="image/*" className="hidden" />
                                    {newItem.image && <button type="button" onClick={(e) => { e.stopPropagation(); removeImage(); }} className="absolute -top-2 -right-2 bg-rose-500 text-white rounded-full p-1 shadow-md hover:bg-rose-600"><Icons.X size={12} /></button>}
                                </div>
                            </div>
                            <div className="grid grid-cols-3 gap-3">
                                <div className="col-span-2"><label className="block text-sm font-medium text-slate-700 mb-1">Nombre</label><input required type="text" className="w-full px-3 py-2 border rounded-lg outline-none focus:border-slate-900" value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} /></div>
                                <div><label className="block text-sm font-medium text-slate-700 mb-1">Tipo</label><select className="w-full px-2 py-2 border rounded-lg outline-none bg-white" value={newItem.type} onChange={e => setNewItem({...newItem, type: e.target.value})}><option value="Moneda">Moneda</option><option value="Lingote">Lingote</option><option value="Joyer√≠a">Joyer√≠a</option><option value="Otro">Otro</option></select></div>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="block text-sm font-medium text-slate-700 mb-1">Metal</label><div className="flex space-x-2"><button type="button" onClick={() => setNewItem({...newItem, metal: 'gold'})} className={`flex-1 py-2 px-2 rounded-lg border text-sm font-medium ${newItem.metal === 'gold' ? 'bg-amber-100 border-amber-400 text-amber-800' : 'text-slate-600'}`}>Oro</button><button type="button" onClick={() => setNewItem({...newItem, metal: 'silver'})} className={`flex-1 py-2 px-2 rounded-lg border text-sm font-medium ${newItem.metal === 'silver' ? 'bg-slate-200 border-slate-400 text-slate-800' : 'text-slate-600'}`}>Plata</button></div></div>
                                <div><label className="block text-sm font-medium text-slate-700 mb-1">Pa√≠s</label><input type="text" className="w-full px-3 py-2 border rounded-lg outline-none focus:border-slate-900" value={newItem.country} onChange={e => setNewItem({...newItem, country: e.target.value})} /></div>
                            </div>
                            <div><label className="block text-sm font-medium text-slate-700 mb-1">Peso</label><div className="flex"><input required type="number" step="0.01" className="w-full px-3 py-2 border rounded-l-lg outline-none focus:border-slate-900" value={newItem.weight} onChange={e => setNewItem({...newItem, weight: e.target.value})} /><select className="bg-slate-100 border border-l-0 rounded-r-lg px-2 text-sm outline-none" value={newItem.unit} onChange={e => setNewItem({...newItem, unit: e.target.value})}><option value="oz">oz</option><option value="g">g</option></select></div></div>
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="block text-sm font-medium text-slate-700 mb-1">Fecha</label><input required type="date" className="w-full px-3 py-2 border rounded-lg outline-none focus:border-slate-900" value={newItem.purchaseDate} onChange={e => setNewItem({...newItem, purchaseDate: e.target.value})} /></div>
                                <div><label className="block text-sm font-medium text-slate-700 mb-1">Coste (‚Ç¨)</label><input required type="number" step="0.01" className="w-full px-3 py-2 border rounded-lg outline-none focus:border-slate-900" value={newItem.purchasePrice} onChange={e => setNewItem({...newItem, purchasePrice: e.target.value})} /></div>
                            </div>
                            <Button type="submit" className="w-full mt-4">{editingId ? "Actualizar" : "Guardar"}</Button>
                        </form>
                    </Modal>

                    <Modal isOpen={isSettingsModalOpen} onClose={() => setIsSettingsModalOpen(false)} title="Gesti√≥n de Datos">
                        <div className="space-y-6">
                            <div className={`p-4 rounded-lg border ${isFirebaseReady ? 'bg-emerald-50 border-emerald-200' : 'bg-slate-100 border-slate-200 opacity-75'}`}>
                                <h4 className="font-semibold text-slate-800 mb-2 flex items-center"><Icons.Cloud size={18} className="mr-2"/> Sincronizaci√≥n en Nube {isSyncEnabled && <span className="ml-2 text-xs bg-emerald-500 text-white px-2 py-0.5 rounded-full">Activa</span>}</h4>
                                <p className="text-sm text-slate-600 mb-3">Mant√©n tus datos sincronizados entre dispositivos (Mac, iPhone) usando una frase secreta.</p>
                                
                                {!isFirebaseReady ? (
                                    <div className="text-xs text-rose-600 font-medium mb-2">‚ö†Ô∏è Falta configuraci√≥n de Firebase en el c√≥digo.</div>
                                ) : (
                                    !isSyncEnabled ? (
                                        <form onSubmit={handleSyncSubmit} className="flex gap-2">
                                            <input name="syncPass" type="text" placeholder="Tu Frase Secreta..." className="flex-1 px-3 py-2 border rounded text-sm" required />
                                            <Button type="submit" className="text-xs">Conectar</Button>
                                        </form>
                                    ) : (
                                        <div className="text-sm text-emerald-700">
                                            <div className="mb-2">
                                                Conectado con frase: <strong>{syncPassphrase}</strong>. <br/>
                                                Estado: <span className={`font-bold ${syncStatus==='connected'?'text-emerald-600':(syncStatus==='error'?'text-rose-600':'text-amber-500')}`}>{syncStatus === 'syncing' ? 'Sincronizando...' : (syncStatus === 'error' ? 'Error' : 'Conectado')}</span>
                                            </div>
                                            {syncMessage === "PERMISSION_DENIED" ? (
                                                <div className="bg-white p-3 rounded border border-rose-200">
                                                    <p className="text-xs text-rose-600 font-bold mb-2">‚õî Error: La base de datos est√° bloqueada.</p>
                                                    <p className="text-xs text-slate-600 mb-2">Para arreglarlo, haz clic abajo y pega el c√≥digo de permisos:</p>
                                                    <Button onClick={openConsole} variant="danger" className="w-full text-xs flex items-center justify-center"><Icons.ExternalLink size={14} className="mr-2"/> Solucionar Permisos (Abrir Consola)</Button>
                                                </div>
                                            ) : (
                                                syncMessage && <div className="text-xs bg-white p-2 rounded border border-emerald-200">{syncMessage}</div>
                                            )}
                                        </div>
                                    )
                                )}
                            </div>

                            <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                                <h4 className="font-semibold text-slate-800 mb-2 flex items-center"><Icons.Download size={18} className="mr-2"/> Copia de Seguridad</h4>
                                <Button onClick={handleExportData} variant="secondary" className="w-full text-xs">Exportar (.json)</Button>
                            </div>
                            <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                                <h4 className="font-semibold text-slate-800 mb-2 flex items-center"><Icons.Upload size={18} className="mr-2"/> Importar</h4>
                                <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".json" />
                                <Button onClick={handleImportClick} variant="primary" className="w-full text-xs">Importar</Button>
                            </div>
                            <div className="border-t pt-4">
                                <Button onClick={() => { if(confirm("¬øEst√°s seguro de BORRAR TODA la colecci√≥n? No se puede deshacer.")) setPortfolio([]); setIsSettingsModalOpen(false); }} variant="danger" className="w-full text-xs">Borrar Todo</Button>
                            </div>
                        </div>
                    </Modal>

                    <Modal isOpen={isPriceModalOpen} onClose={() => setIsPriceModalOpen(false)} title="Ajuste Manual (‚Ç¨/oz)">
                        <form onSubmit={handleUpdatePrices} className="space-y-4">
                            <div><label className="text-sm font-medium">Oro</label><input name="goldPrice" type="number" step="0.01" defaultValue={spotPrices.gold} className="w-full px-3 py-2 border rounded-lg font-mono" /></div>
                            <div><label className="text-sm font-medium">Plata</label><input name="silverPrice" type="number" step="0.01" defaultValue={spotPrices.silver} className="w-full px-3 py-2 border rounded-lg font-mono" /></div>
                            <Button type="submit" className="w-full mt-2">Actualizar Precios</Button>
                        </form>
                    </Modal>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
